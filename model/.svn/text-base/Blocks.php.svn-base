<?php

/**
 * Manage the hard/soft blocks of deploy
 * Block status is stored in apc right now
 */
class Model_Blocks {
    
    /**
     * 
     */
    const SOFTCACHEKEY = 'softblock';
    const HARDCACHEKEY = 'hardblock';
    
    
    protected $data;
    
    public $softBlock = false;
    
    public $hardBlock = false;
    
    
    public function __construct(){
        $softBlock = apc_fetch(self::SOFTCACHEKEY);
        $hardBlock = apc_fetch(self::HARDCACHEKEY);
        
        if($softBlock){
            $this->softBlock = $softBlock;
        }
        
        if($hardBlock){
            $this->hardBlock = $hardBlock;
        }
        
    }
    
    public function setSoftBlock(Model_ByUser $user, $message){
        if($this->hardBlock || $this->softBlock){
            return false;
        }
        
        $stage = new Model_Stage();
        $deploy = new Model_Deploy();
        $events = new Model_Events();
        
        if($stage->isRunning() || $deploy->isRunning()){
            $events->addEvent('block', $user, "Tried to block but was too late: " . $message, LogLevel::INFO);
            return;
        }
        
        $this->softBlock = array( 'user' => $user, 'message' => $message);
        apc_store(self::SOFTCACHEKEY, $this->softBlock);
        
        
        
        $events->addEvent('block', $user, "Deploy Soft Blocked: " . $message, LogLevel::BLOCK);
        
    }
    
    public function setHardBlock(Model_ByUser $user, $message){
        if($this->hardBlock || $this->softBlock){
            return false;
        }
        
        $stage = new Model_Stage();
        $deploy = new Model_Deploy();
        $events = new Model_Events();
        
        if($stage->isRunning() || $deploy->isRunning()){
            $events->addEvent('block', $user, "Tried to block but was too late: " . $message, LogLevel::INFO);
            return;
        }
        
        $this->hardBlock = array( 'user' => $user, 'message' => $message);
        apc_store(self::HARDCACHEKEY, $this->hardBlock);
        $events = new Model_Events();
        $events->addEvent('block', $user, "Deploy Hard Blocked: " . $message, LogLevel::BLOCK);
    }
    
    
    public function unBlock(Model_ByUser $user, $message){
        
        if($this->softBlock || $this->hardBlock){
            $events = new Model_Events();
            $events->addEvent('block', $user, "DEPLOY OK " . $message, LogLevel::BLOCK);
        }
        
        $this->softBlock = false;
        $this->hardBlock = false;
        apc_delete(self::SOFTCACHEKEY);
        apc_delete(self::HARDCACHEKEY);

    }
    
}